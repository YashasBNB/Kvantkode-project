import assert from 'assert';
import { ensureNoDisposablesAreLeakedInTestSuite } from '../../../../base/test/common/utils.js';
import { OneDataSystemWebAppender } from '../../browser/1dsAppender.js';
class AppInsightsCoreMock {
    constructor() {
        this.pluginVersionString = 'Test Runner';
        this.events = [];
        this.IsTrackingPageView = false;
        this.exceptions = [];
    }
    track(event) {
        this.events.push(event.baseData);
    }
    unload(isAsync, unloadComplete) {
        // No-op
    }
}
suite('AIAdapter', () => {
    let appInsightsMock;
    let adapter;
    const prefix = 'prefix';
    teardown(() => {
        adapter.flush();
    });
    ensureNoDisposablesAreLeakedInTestSuite();
    setup(() => {
        appInsightsMock = new AppInsightsCoreMock();
        adapter = new OneDataSystemWebAppender(false, prefix, undefined, () => appInsightsMock);
    });
    test('Simple event', () => {
        adapter.log('testEvent');
        assert.strictEqual(appInsightsMock.events.length, 1);
        assert.strictEqual(appInsightsMock.events[0].name, `${prefix}/testEvent`);
    });
    test('addional data', () => {
        adapter = new OneDataSystemWebAppender(false, prefix, { first: '1st', second: 2, third: true }, () => appInsightsMock);
        adapter.log('testEvent');
        assert.strictEqual(appInsightsMock.events.length, 1);
        const [first] = appInsightsMock.events;
        assert.strictEqual(first.name, `${prefix}/testEvent`);
        assert.strictEqual(first.properties['first'], '1st');
        assert.strictEqual(first.measurements['second'], 2);
        assert.strictEqual(first.measurements['third'], 1);
    });
    test('property limits', () => {
        let reallyLongPropertyName = 'abcdefghijklmnopqrstuvwxyz';
        for (let i = 0; i < 6; i++) {
            reallyLongPropertyName += 'abcdefghijklmnopqrstuvwxyz';
        }
        assert(reallyLongPropertyName.length > 150);
        let reallyLongPropertyValue = 'abcdefghijklmnopqrstuvwxyz012345678901234567890123';
        for (let i = 0; i < 400; i++) {
            reallyLongPropertyValue += 'abcdefghijklmnopqrstuvwxyz012345678901234567890123';
        }
        assert(reallyLongPropertyValue.length > 8192);
        const data = Object.create(null);
        data[reallyLongPropertyName] = '1234';
        data['reallyLongPropertyValue'] = reallyLongPropertyValue;
        adapter.log('testEvent', data);
        assert.strictEqual(appInsightsMock.events.length, 1);
        for (const prop in appInsightsMock.events[0].properties) {
            assert(prop.length < 150);
            assert(appInsightsMock.events[0].properties[prop].length < 8192);
        }
    });
    test('Different data types', () => {
        const date = new Date();
        adapter.log('testEvent', {
            favoriteDate: date,
            likeRed: false,
            likeBlue: true,
            favoriteNumber: 1,
            favoriteColor: 'blue',
            favoriteCars: ['bmw', 'audi', 'ford'],
        });
        assert.strictEqual(appInsightsMock.events.length, 1);
        assert.strictEqual(appInsightsMock.events[0].name, `${prefix}/testEvent`);
        assert.strictEqual(appInsightsMock.events[0].properties['favoriteColor'], 'blue');
        assert.strictEqual(appInsightsMock.events[0].measurements['likeRed'], 0);
        assert.strictEqual(appInsightsMock.events[0].measurements['likeBlue'], 1);
        assert.strictEqual(appInsightsMock.events[0].properties['favoriteDate'], date.toISOString());
        assert.strictEqual(appInsightsMock.events[0].properties['favoriteCars'], JSON.stringify(['bmw', 'audi', 'ford']));
        assert.strictEqual(appInsightsMock.events[0].measurements['favoriteNumber'], 1);
    });
    test('Nested data', () => {
        adapter.log('testEvent', {
            window: {
                title: 'some title',
                measurements: {
                    width: 100,
                    height: 200,
                },
            },
            nestedObj: {
                nestedObj2: {
                    nestedObj3: {
                        testProperty: 'test',
                    },
                },
                testMeasurement: 1,
            },
        });
        assert.strictEqual(appInsightsMock.events.length, 1);
        assert.strictEqual(appInsightsMock.events[0].name, `${prefix}/testEvent`);
        assert.strictEqual(appInsightsMock.events[0].properties['window.title'], 'some title');
        assert.strictEqual(appInsightsMock.events[0].measurements['window.measurements.width'], 100);
        assert.strictEqual(appInsightsMock.events[0].measurements['window.measurements.height'], 200);
        assert.strictEqual(appInsightsMock.events[0].properties['nestedObj.nestedObj2.nestedObj3'], JSON.stringify({ testProperty: 'test' }));
        assert.strictEqual(appInsightsMock.events[0].measurements['nestedObj.testMeasurement'], 1);
    });
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiMWRzQXBwZW5kZXIudGVzdC5qcyIsInNvdXJjZVJvb3QiOiJmaWxlOi8vL1VzZXJzL3lhc2hhc25haWR1L0t2YW50Y29kZS92b2lkL3NyYy8iLCJzb3VyY2VzIjpbInZzL3BsYXRmb3JtL3RlbGVtZXRyeS90ZXN0L2Jyb3dzZXIvMWRzQXBwZW5kZXIudGVzdC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFLQSxPQUFPLE1BQU0sTUFBTSxRQUFRLENBQUE7QUFDM0IsT0FBTyxFQUFFLHVDQUF1QyxFQUFFLE1BQU0sdUNBQXVDLENBQUE7QUFDL0YsT0FBTyxFQUFFLHdCQUF3QixFQUFFLE1BQU0sOEJBQThCLENBQUE7QUFHdkUsTUFBTSxtQkFBbUI7SUFBekI7UUFDQyx3QkFBbUIsR0FBVyxhQUFhLENBQUE7UUFDcEMsV0FBTSxHQUFVLEVBQUUsQ0FBQTtRQUNsQix1QkFBa0IsR0FBWSxLQUFLLENBQUE7UUFDbkMsZUFBVSxHQUFVLEVBQUUsQ0FBQTtJQVk5QixDQUFDO0lBVk8sS0FBSyxDQUFDLEtBQXFCO1FBQ2pDLElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxRQUFRLENBQUMsQ0FBQTtJQUNqQyxDQUFDO0lBRU0sTUFBTSxDQUNaLE9BQWdCLEVBQ2hCLGNBQTREO1FBRTVELFFBQVE7SUFDVCxDQUFDO0NBQ0Q7QUFFRCxLQUFLLENBQUMsV0FBVyxFQUFFLEdBQUcsRUFBRTtJQUN2QixJQUFJLGVBQW9DLENBQUE7SUFDeEMsSUFBSSxPQUFpQyxDQUFBO0lBQ3JDLE1BQU0sTUFBTSxHQUFHLFFBQVEsQ0FBQTtJQUV2QixRQUFRLENBQUMsR0FBRyxFQUFFO1FBQ2IsT0FBTyxDQUFDLEtBQUssRUFBRSxDQUFBO0lBQ2hCLENBQUMsQ0FBQyxDQUFBO0lBRUYsdUNBQXVDLEVBQUUsQ0FBQTtJQUV6QyxLQUFLLENBQUMsR0FBRyxFQUFFO1FBQ1YsZUFBZSxHQUFHLElBQUksbUJBQW1CLEVBQUUsQ0FBQTtRQUMzQyxPQUFPLEdBQUcsSUFB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