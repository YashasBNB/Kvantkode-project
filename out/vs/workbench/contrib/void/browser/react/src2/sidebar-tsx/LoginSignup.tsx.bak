import React, { useState } from 'react'
import { getBackendBase } from './AuthGate.js'

export const LoginSignup = ({ onAuthed }: { onAuthed: (token: string) => void }) => {
	const [mode, setMode] = useState<'login' | 'signup'>('login')
	const [email, setEmail] = useState('')
	const [username, setUsername] = useState('')
	const [password, setPassword] = useState('')
	const [loading, setLoading] = useState(false)
	const [error, setError] = useState<string | null>(null)

	const submit = async () => {
		setLoading(true)
		setError(null)
		try {
			const endpoint = mode === 'login' ? '/auth/login' : '/auth/register'
			const payload: any = { email, password }
			if (mode === 'signup') payload.username = username || email.split('@')[0]
			const rsp = await fetch(`${getBackendBase()}${endpoint}`, {
				method: 'POST',
				headers: { 'Content-Type': 'application/json' },
				body: JSON.stringify(payload),
			})
			const data = await rsp.json()
			if (!rsp.ok) throw new Error(data?.error || 'auth_failed')
			if (data?.token) onAuthed(data.token)
		} catch (e: any) {
			setError(e.message || 'Failed')
		} finally {
			setLoading(false)
		}
	}

	return (
		<div className="void-w-full void-h-full void-flex void-items-center void-justify-center">
			<div className="void-w-full void-max-w-sm void-bg-void-bg-3 void-border void-border-void-border-3 void-rounded void-p-4">
				<div className="void-text-lg void-mb-3">{mode === 'login' ? 'Log in' : 'Sign up'}</div>
				{mode === 'signup' && (
					<div className="void-mb-2">
						<label className="void-text-xs void-text-void-fg-3">Username</label>
						<input
							className="void-w-full void-mt-1 void-p-2 void-bg-void-bg-1 void-border void-border-void-border-3 void-rounded"
							value={username}
							onChange={(e) => setUsername(e.target.value)}
							placeholder="yourname"
						/>
					</div>
				)}
				<div className="void-mb-2">
					<label className="void-text-xs void-text-void-fg-3">Email</label>
					<input
						className="void-w-full void-mt-1 void-p-2 void-bg-void-bg-1 void-border void-border-void-border-3 void-rounded"
						value={email}
						onChange={(e) => setEmail(e.target.value)}
						placeholder="you@example.com"
					/>
				</div>
				<div className="void-mb-3">
					<label className="void-text-xs void-text-void-fg-3">Password</label>
					<input
						type="password"
						className="void-w-full void-mt-1 void-p-2 void-bg-void-bg-1 void-border void-border-void-border-3 void-rounded"
						value={password}
						onChange={(e) => setPassword(e.target.value)}
						placeholder="••••••••"
					/>
				</div>
				{error && <div className="void-text-red-400 void-text-xs void-mb-2">{String(error)}</div>}
				<button
					disabled={loading}
					onClick={submit}
					className={`void-w-full void-py-2 void-rounded ${loading ? 'void-opacity-70' : ''} void-bg-white void-text-black`}
				>
					{loading ? 'Please wait…' : mode === 'login' ? 'Log in' : 'Create account'}
				</button>
				<div className="void-text-xs void-text-void-fg-3 void-mt-3">
					{mode === 'login' ? (
						<>
							No account?{' '}
							<button className="void-underline" onClick={() => setMode('signup')}>
								Sign up
							</button>
						</>
					) : (
						<>
							Have an account?{' '}
							<button className="void-underline" onClick={() => setMode('login')}>
								Log in
							</button>
						</>
					)}
				</div>
			</div>
		</div>
	)
}
